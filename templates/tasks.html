{% extends "base.html" %}
{% block title %}Tasks - Task Manager Pro{% endblock %}

{% block content %}
<div class="container">
    <div class="tasks-header">
        <h2 class="page-title">
            <i class="fas fa-list-check"></i>
            Task Management
        </h2>
        <p class="page-subtitle">View, edit, and manage all your extracted tasks</p>
    </div>

    {% if stats %}
    <div class="stats-banner">
        <div class="stat-item">
            <span class="stat-label">Total</span>
            <span class="stat-value">{{ stats.total }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Pending</span>
            <span class="stat-value">{{ stats.pending }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Completed</span>
            <span class="stat-value">{{ stats.completed }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Progress</span>
            <span class="stat-value">{{ "%.1f"|format(stats.completion_rate) }}%</span>
        </div>
    </div>
    {% endif %}

    <div class="controls-section">
        <div class="search-box">
            <form method="GET" action="/tasks" class="search-form">
                <div class="search-input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" name="search" placeholder="Search tasks..." 
                           value="{{ current_filters.search if current_filters and current_filters.search else '' }}"
                           class="search-input">
                    <button type="submit" class="search-btn">Search</button>
                </div>
            </form>
        </div>

        <div class="filter-controls">
            <form method="GET" action="/tasks" class="filter-form">
                <select name="status" class="filter-select" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="pending" {% if current_filters and current_filters.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="in_progress" {% if current_filters and current_filters.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if current_filters and current_filters.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if current_filters and current_filters.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>

                <select name="priority" class="filter-select" onchange="this.form.submit()">
                    <option value="">All Priorities</option>
                    <option value="high" {% if current_filters and current_filters.priority == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if current_filters and current_filters.priority == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if current_filters and current_filters.priority == 'low' %}selected{% endif %}>Low</option>
                </select>

                {% if current_filters and (current_filters.status or current_filters.priority or current_filters.search) %}
                <a href="/tasks" class="clear-filters">Clear Filters</a>
                {% endif %}
            </form>
        </div>
    </div>

    {% if error %}
    <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
    </div>
    {% endif %}

    {% if tasks %}
    <div class="tasks-section">
        <div class="tasks-grid">
            {% for task in tasks %}
            <div class="task-card {% if task.completed %}completed{% endif %}" data-task-id="{{ task._id }}">
                <div class="task-header">
                    <div class="task-priority {{ task.priority if task.priority else 'medium' }}">
                        <i class="fas fa-flag"></i>
                        {{ task.priority if task.priority else 'medium' }}
                    </div>
                    <div class="task-status {{ task.status if task.status else 'pending' }}">
                        <i class="fas fa-circle"></i>
                        {{ task.status if task.status else 'pending' }}
                    </div>
                </div>

                <div class="task-content">
                    <h4 class="task-title">{{ task.title }}</h4>
                    <div class="task-date">
                        <i class="fas fa-calendar"></i>
                        {{ task.date }}
                    </div>
                    {% if task.description %}
                    <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                    {% if task.tags %}
                    <div class="task-tags">
                        {% for tag in task.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="task-actions">
                    {% if not task.completed %}
                    <button class="btn btn-success btn-sm" onclick="markComplete('{{ task._id }}')">
                        <i class="fas fa-check"></i>
                        Complete
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-primary btn-sm" onclick="editTask('{{ task._id }}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    
                    <button class="btn btn-danger btn-sm" onclick="deleteTask('{{ task._id }}')">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="no-tasks-section">
        <div class="no-tasks-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <h3>No Tasks Found</h3>
        <p>{% if current_filters and (current_filters.status or current_filters.priority or current_filters.search) %}
            No tasks match your current filters. Try adjusting your search criteria.
        {% else %}
            You haven't uploaded any images yet. Start by uploading a datasheet or schedule image.
        {% endif %}</p>
        
        <div class="actions-section">
            <a href="/" class="btn btn-primary">
                <i class="fas fa-upload"></i>
                Upload Image
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Task Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Task</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="editForm" method="POST" action="/tasks/update">
            <input type="hidden" id="editTaskId" name="task_id">
            
            <div class="form-group">
                <label for="editTitle">Title</label>
                <input type="text" id="editTitle" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="editDate">Date</label>
                <input type="date" id="editDate" name="date" required>
            </div>
            
            <div class="form-group">
                <label for="editPriority">Priority</label>
                <select id="editPriority" name="priority" required>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editStatus">Status</label>
                <select id="editStatus" name="status" required>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editDescription">Description</label>
                <textarea id="editDescription" name="description" rows="3"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Task</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function markComplete(taskId) {
    if (confirm('Mark this task as complete?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/tasks/complete';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'task_id';
        input.value = taskId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/tasks/delete';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'task_id';
        input.value = taskId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function editTask(taskId) {
    // Get task data from the card
    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
    const title = taskCard.querySelector('.task-title').textContent;
    const date = taskCard.querySelector('.task-date').textContent.trim().split(' ')[1];
    const priority = taskCard.querySelector('.task-priority').textContent.trim();
    const status = taskCard.querySelector('.task-status').textContent.trim();
    
    // Populate modal
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('editTitle').value = title;
    document.getElementById('editDate').value = date;
    document.getElementById('editPriority').value = priority;
    document.getElementById('editStatus').value = status;
    
    // Show modal
    document.getElementById('editModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
